# Recon and Enumeration

The first phase of the Outsider is the Recon and Enumeration phase.

### OSINT

Look for urls that contains <alias>.signin.aws.amazon.com with an alias related to the organization.

### Marketplace

If a vendor has instances in the marketplace, you can get the owner id (account id) of the AWS account he used.

### Snapshots

- Git, Github, Gitlab
- Share-stuff
- API Collections
- Search in Developer Plattforms
 Tools: git-hound
 
shed changes
Public EBS snapshots (EC2 -> Snapshots -> Public Snapshots)

RDS public snapshots (RDS -> Snapshots -> All Public Snapshots)

Public AMIs (EC2 -> AMIs -> Public images)

### Recon Tools
- [Thoth](https://github.com/r1cksec/thoth)
- ....


## 1.2 Recon/Enumeration: S3 Public Buckets

es gibt permissions per bucket, per object oder per iam und dann gibts noch acl - S3 Beschreibung ergänzen - siehe Gschwendo Tweet

### Finding AWS Buckets

#### Brute Force

You can find buckets by brute-forcing names related to the company you are pentesting:

- S3Scanner
- S3-Inspector
- AWSBucketDump

```
 # Generate a wordlist to create permutations
curl -s https://raw.githubusercontent.com/cujanovic/goaltdns/master/words.txt > /tmp/words-s3.txt.temp
curl -s https://raw.githubusercontent.com/jordanpotti/AWSBucketDump/master/BucketNames.txt >>/tmp/words-s3.txt.temp
cat /tmp/words-s3.txt.temp | sort -u > /tmp/words-s3.txt

# Generate a wordlist based on the domains and subdomains to test
## Write those domains and subdomains in subdomains.txt
cat subdomains.txt > /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "-" >> /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "\n" | sort -u >> /tmp/words-hosts-s3.txt

# Create permutations based in a list with the domains and subdomains to attack
goaltdns -l /tmp/words-hosts-s3.txt -w /tmp/words-s3.txt -o /tmp/final-words-s3.txt.temp
## The previous tool is specialized increating permutations for subdomains, lets filter that list
### Remove lines ending with "."
cat /tmp/final-words-s3.txt.temp | grep -Ev "\.$" > /tmp/final-words-s3.txt.temp2
### Create list without TLD
cat /tmp/final-words-s3.txt.temp2 | sed -E 's/\.[a-zA-Z0-9]+$//' > /tmp/final-words-s3.txt.temp3
### Create list without dots
cat /tmp/final-words-s3.txt.temp3 | tr -d "." > /tmp/final-words-s3.txt.temp4http://phantom.s3.amazonaws.com/
### Create list without hyphens
cat /tmp/final-words-s3.txt.temp3 | tr "." "-" > /tmp/final-words-s3.txt.temp5

## Generate the final wordlist
cat /tmp/final-words-s3.txt.temp2 /tmp/final-words-s3.txt.temp3 /tmp/final-words-s3.txt.temp4 /tmp/final-words-s3.txt.temp5 | grep -v -- "-\." | awk '{print tolower($0)}' | sort -u > /tmp/final-words-s3.txt

## Call s3scanner
s3scanner --threads 100 scan --buckets-file /tmp/final-words-s3.txt  | grep bucket_exists

```

### Enumerating the bucket

To test the openness of the bucket a user can just enter the URL in their web browser. A private bucket will respond with "Access Denied". A public bucket will list the first 1,000 objects that have been stored.
 G: nein das is faktisch falsch, access denies heist nur du darfst grade nicht aus gründen, acl, permission. geo-locatins etc, das heist nihc ob puplic oder nicht, das ist auch nichso binär

```
#Use --no-sign-request for check Everyones permissions
#Use --profile <PROFILE_NAME> to indicate the AWS profile(keys) that youwant to use: Check for "Any Authenticated AWS User" permissions
#--recursive if you want list recursivelyls
#Opcionally you can select the region if you now it
aws s3 ls s3://flaws.cloud/ [--no-sign-request] [--profile <PROFILE_NAME>] [ --recursive] [--region us-west-2]
```

```
aws s3 --no-sign-request --region ap-southeast-1 ls s3://static-resources-examples
```

If the bucket doesn't have a domain name, when trying to enumerate it, only put the bucket name and not the whole AWSs3 domain. Example: s3://<BUCKETNAME>

## 1.3 Recon/ Enumeration: EC2 Unauthenticated Enum

### Public Ports

Ports to see what is running on the machines
 
### Public AMIs & EBS Snapshots
 
 ```
 # Public AMIs
aws ec2 describe-images --executable-users all
## Search AMI by ownerID
aws ec2 describe-images --executable-users all --query 'Images[?contains(ImageLocation, `967541184254/`) == `true`]'
## Search AMI by substr ("shared" in the example)
aws ec2 describe-images --executable-users all --query 'Images[?contains(ImageLocation, `shared`) == `true`]'

# Public EBS snapshots (hard-drive copies)
aws ec2 describe-snapshots --restorable-by-user-ids all
aws ec2 describe-snapshots --restorable-by-user-ids all | jq '.Snapshots[] | select(.OwnerId == "099720109477")'
 
 aws ec2 describe-snapshots --restorable-by-user-ids all --owner-ids 000000000000
 ```
 
 ```
 use Prowler
 ./prowler -c ec2_ebs_public_snapshot
 ```

 ### Public URL template
 
```
 # EC2
ec2-{ip-seperated}.compute-1.amazonaws.com
# ELB
http://{user_provided}-{random_id}.{region}.elb.amazonaws.com:80/443
https://{user_provided}-{random_id}.{region}.elb.amazonaws.com
 ```
 
## 1.4 Recon/Enumeration: Lambda Unauthenticated Access

### Public Function URL

It's possible to relate a Lambda with a public function URL that anyone can access. It could contain web vulnerabilities.

### Public URL template

```
https://{random_id}.lambda-url.{region}.on.aws/
```

## 1.5 Recon/Enumeration: Api Gateway Unauthencticated Enum

### API Invoke Bypass
Lambda Authorizers can be configured using IAM syntax to give permissions to invoke API endpoints.

```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Permission",
      "Action": [
        "execute-api:Execution-operation"           
      ],
      "Resource": [
        "arn:aws:execute-api:region:account-id:api-id/stage/METHOD_HTTP_VERB/Resource-path"
      ]
    }
  ]
} 
```

### IAM Policy Injection

the code is using user input to generate the IAM policies, wildcards (and others such as "." or specific strings) can be included in there with the goal of bypassing restrictions.

### Public URL template

```
https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided}
```

## 1.6 Recon/Enumeration: Databases -> RDS Unauthenticated Enum

### Public Port

It's possible to expose the database port to the internet. 

### Public RDS Snapshots

```
# Public RDS snapshots
aws rds describe-db-snapshots --include-public
## Search by account ID
aws rds describe-db-snapshots --include-public --query 'DBSnapshots[?contains(DBSnapshotIdentifier, `284546856933:`) == `true`]'
## To share a RDS snapshot with everybody the RDS DB cannot be encrypted (so the snapshot won't be encryted)
## To share a RDS encrypted snapshot you need to share the KMS key also with the account


# From the own account you can check if there is any public snapshot with:
aws rds describe-db-snapshots --snapshot-type public [--region us-west-2]
## Even if in the console appear as there are public snapshot it might be public
## snapshots from other accounts used by the current account
```

### Public URL template

```
mysql://{user_provided}.{random_id}.{region}.rds.amazonaws.com:3306
postgres://{user_provided}.{random_id}.{region}.rds.amazonaws.com:5432
```

## Quelle:

https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-accounts-unauthenticated-enum
https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum
Gschwendo Twitter Feeds

## Tools I used in the last pentest

```
Cloudbrute -d <url> -k <something> -w wordlist
```

