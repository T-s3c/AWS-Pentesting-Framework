# Recon and Enumeration

The first phase of the Outsider is the Recon and Enumeration phase.

### OSINT

Look for urls that contains <alias>.signin.aws.amazon.com with an alias related to the organization.

### Marketplace

If a vendor has instances in the marketplace, you can get the owner id (account id) of the AWS account he used.

### Snapshots

- Git, Github, Gitlab
- Share-stuff
- API Collections
- Search in Developer Plattforms
 Tools: git-hound
 
shed changes
Public EBS snapshots (EC2 -> Snapshots -> Public Snapshots)

RDS public snapshots (RDS -> Snapshots -> All Public Snapshots)

Public AMIs (EC2 -> AMIs -> Public images)

### Recon Tools
- [Thoth](https://github.com/r1cksec/thoth)
- ....

## 1.3 Recon/ Enumeration: EC2 Unauthenticated Enum

### Public Ports

Ports to see what is running on the machines
 
### Public AMIs & EBS Snapshots
 
 ```
 # Public AMIs
aws ec2 describe-images --executable-users all
## Search AMI by ownerID
aws ec2 describe-images --executable-users all --query 'Images[?contains(ImageLocation, `967541184254/`) == `true`]'
## Search AMI by substr ("shared" in the example)
aws ec2 describe-images --executable-users all --query 'Images[?contains(ImageLocation, `shared`) == `true`]'

# Public EBS snapshots (hard-drive copies)
aws ec2 describe-snapshots --restorable-by-user-ids all
aws ec2 describe-snapshots --restorable-by-user-ids all | jq '.Snapshots[] | select(.OwnerId == "099720109477")'
 
 aws ec2 describe-snapshots --restorable-by-user-ids all --owner-ids 000000000000
 ```
 
 ```
 use Prowler
 ./prowler -c ec2_ebs_public_snapshot
 ```

 ### Public URL template
 
```
 # EC2
ec2-{ip-seperated}.compute-1.amazonaws.com
# ELB
http://{user_provided}-{random_id}.{region}.elb.amazonaws.com:80/443
https://{user_provided}-{random_id}.{region}.elb.amazonaws.com
 ```
 
## 1.4 Recon/Enumeration: Lambda Unauthenticated Access

### Public Function URL

It's possible to relate a Lambda with a public function URL that anyone can access. It could contain web vulnerabilities.

### Public URL template

```
https://{random_id}.lambda-url.{region}.on.aws/
```

## 1.5 Recon/Enumeration: Api Gateway Unauthencticated Enum

### API Invoke Bypass
Lambda Authorizers can be configured using IAM syntax to give permissions to invoke API endpoints.

```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Permission",
      "Action": [
        "execute-api:Execution-operation"           
      ],
      "Resource": [
        "arn:aws:execute-api:region:account-id:api-id/stage/METHOD_HTTP_VERB/Resource-path"
      ]
    }
  ]
} 
```

### IAM Policy Injection

the code is using user input to generate the IAM policies, wildcards (and others such as "." or specific strings) can be included in there with the goal of bypassing restrictions.

### Public URL template

```
https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided}
```

## 1.6 Recon/Enumeration: Databases -> RDS Unauthenticated Enum

### Public Port

It's possible to expose the database port to the internet. 

### Public RDS Snapshots

```
# Public RDS snapshots
aws rds describe-db-snapshots --include-public
## Search by account ID
aws rds describe-db-snapshots --include-public --query 'DBSnapshots[?contains(DBSnapshotIdentifier, `284546856933:`) == `true`]'
## To share a RDS snapshot with everybody the RDS DB cannot be encrypted (so the snapshot won't be encryted)
## To share a RDS encrypted snapshot you need to share the KMS key also with the account


# From the own account you can check if there is any public snapshot with:
aws rds describe-db-snapshots --snapshot-type public [--region us-west-2]
## Even if in the console appear as there are public snapshot it might be public
## snapshots from other accounts used by the current account
```

### Public URL template

```
mysql://{user_provided}.{random_id}.{region}.rds.amazonaws.com:3306
postgres://{user_provided}.{random_id}.{region}.rds.amazonaws.com:5432
```

## Quelle:

https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-accounts-unauthenticated-enum
https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum
Gschwendo Twitter Feeds

## Tools I used in the last pentest

```
Cloudbrute -d <url> -k <something> -w wordlist
```

